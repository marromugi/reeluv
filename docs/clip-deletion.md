# VideoClip 削除仕様

## 1. 目的

本仕様は、VideoClipの削除に関するビジネスルールと振る舞いを定義する。

## 2. 用語定義

| 用語 | 定義 |
|------|------|
| VideoClip | 映像素材を表すエンティティ |
| ShowReel | 複数のVideoClipで構成される成果物（製品） |
| ソフトデリート | データを物理的に削除せず、削除フラグを立てる論理削除 |
| 物理削除 | データベースからレコードを完全に削除すること |
| 孤立クリップ | どのShowReelからも参照されていないクリップ |

## 3. ビジネス要件

### 3.1 基本方針

ShowReelは納品物・成果物としての性質を持つ。そのため、ShowReelの構成情報は元素材の状態に依存せず保持される必要がある。

### 3.2 要件一覧

| ID | 要件 |
|----|------|
| REQ-1 | VideoClipが削除されても、ShowReel内のクリップ参照は維持されること |
| REQ-2 | 削除されたVideoClipは、通常の検索・一覧から除外されること |
| REQ-3 | ShowReelから参照されていない削除済みクリップは、完全に削除可能であること |
| REQ-4 | 削除されたVideoClipは復元可能であること |

## 4. 削除の種類

### 4.1 ソフトデリート（論理削除）

ユーザーが実行する通常の削除操作。

**事前条件:**
- 対象のVideoClipが存在すること

**事後条件:**
- VideoClipは「削除済み」状態となる
- 通常の検索・一覧からは除外される
- ShowReel内の参照は維持される

**制約:**
- なし（いつでも実行可能）

### 4.2 物理削除（完全削除）

データベースからレコードを完全に削除する操作。

**事前条件:**
- 対象のVideoClipがソフトデリート済みであること
- 対象のVideoClipがどのShowReelからも参照されていないこと

**事後条件:**
- VideoClipのレコードがデータベースから削除される
- 復元不可能となる

**制約:**
- ShowReelから参照されている場合は実行不可

### 4.3 一括物理削除（パージ）

孤立した削除済みクリップを一括で物理削除するバッチ処理。

**対象:**
- ソフトデリート済み かつ どのShowReelからも参照されていないVideoClip

**実行タイミング:**
- 定期バッチ処理（cronジョブ等）

## 5. 状態遷移

```
                    ┌──────────────┐
                    │   アクティブ  │
                    └──────┬───────┘
                           │
                    ソフトデリート
                           │
                           ▼
                    ┌──────────────┐
        ┌──────────│  削除済み    │──────────┐
        │          └──────────────┘          │
        │                                    │
      復元                              物理削除
        │                           （条件を満たす場合のみ）
        │                                    │
        ▼                                    ▼
 ┌──────────────┐                    ┌──────────────┐
 │   アクティブ  │                    │   完全削除   │
 └──────────────┘                    └──────────────┘
```

## 6. VideoClipの状態

| 状態 | 条件 | 検索対象 | ShowReel参照 |
|------|------|----------|-------------|
| アクティブ | deleted_at = NULL | 含まれる | 可能 |
| 削除済み | deleted_at ≠ NULL | 除外 | 維持される |

## 7. ShowReelとの関係

### 7.1 クリップ追加

- アクティブなVideoClipのみ追加可能
- 削除済みのVideoClipは追加不可

### 7.2 削除済みクリップの表示

ShowReelを取得した際、削除済みのクリップも含めて返却される。
各クリップは削除状態を持ち、UI側で適切に表示を制御できる。

### 7.3 合計時間計算

ShowReelの合計時間（totalDuration）は、削除済みクリップを含めて計算される。
これは、ShowReelが特定時点の構成を表す成果物であるため。

## 8. エラー条件

| 操作 | エラー条件 | エラー種別 |
|------|-----------|-----------|
| 物理削除 | ソフトデリートされていない | ClipNotSoftDeletedError |
| 物理削除 | ShowReelから参照されている | ClipInUseError |
| 復元 | クリップが存在しない | ClipNotFoundError |

## 9. データ整合性

### 9.1 外部キー制約

ShowReelとVideoClipの関連テーブルにおいて、VideoClip削除時の動作は `NO ACTION` とする。
これにより、参照されているVideoClipの物理削除はデータベースレベルで防止される。

### 9.2 不変条件

- ソフトデリート済みでないVideoClipは物理削除できない
- ShowReelから参照されているVideoClipは物理削除できない
